<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>@ViewBag.Title</title>
    <link href='/assets/img/favicon.png' rel='icon' type='image/x-icon' />
    <link rel="apple-touch-icon" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="~/assets/css/main.css">
    <link rel="stylesheet" href="~/assets/css/home-responsive.css">
    <link rel="stylesheet" href="~/assets/css/toast-message.css">
    <link rel="stylesheet" href="~/assets/font/font-awesome-pro-v6-6.2.0/css/all.min.css" />
    <script src="~/Scripts/angular.min.js"></script>
    <script src="~/Scripts/angular-sanitize.min.js"></script>
    <script src="~/Scripts/angular-animate.min.js"></script>
    @RenderSection("css_header", required: false)
    @RenderSection("scripts_header", required: false)
    <style>
        #pageLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5); /* màu nền trong suốt */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--red)
        }
        /*angularjs animate*/
        /*ng-repeat*/
        .ng-enter {
            transition: 0.5s linear all;
            opacity: 0;
        }

        .ng-enter-active {
            opacity: 1;
        }
    </style>
    <script>
        const shareData = {
            newId: 0,
            isAuthenticated: '@Request.IsAuthenticated' == 'True',
            tableId: '@ViewBag.TableId',
            tableToken: '@ViewBag.TableToken',
            companySlug: '@ViewBag.CompanySlug',
            loadButton: {
                rootText: '',
                loading: function (button, isShowRootText) {
                    this.rootText = button.innerHTML;
                    //--
                    let text = '';
                    if (isShowRootText) {
                        text = button.innerHTML;
                    }
                    button.disabled = true;
                    button.innerHTML = `<i class="fa-solid fa-loader fa-spin fa-spin-reverse"></i> ${text}`;
                },
                loaded: function (button) {
                    button.disabled = false;
                    button.innerHTML = this.rootText;
                    //--
                    this.rootText = '';
                }
            },
            notification: {
                messageExceptionAPI: '@Html.Raw(Support.ResponsesAPI.MessageAPI.messageException)',
                fail: function (message) {
                    alert(`⚠️@Html.Raw(Support.ResponsesAPI.MessageAPI.failTitle)! ${message}`)
                },
                exception: function () {
                    alert('⚠️' + shareData.notification.messageExceptionAPI)
                }
            }
        }
    </script>
</head>
<body>
    <!-- Overlay -->
    <div id="pageLoader">
        <i class="fa-solid fa-loader fa-spin fa-spin-reverse fa-3x"></i>
    </div>
    <div ng-app="orderApp">
        <header ng-controller="headerCtrl">
            <div class="header-top">
                <div class="container">
                    <div class="header-top-left">
                        <ul class="header-top-list">
                            <li><a href=""><i class="fa-regular fa-phone"></i> 0123 456 789 (miễn phí)</a></li>
                            <li><a href=""><i class="fa-light fa-location-dot"></i> Xem vị trí cửa hàng</a></li>
                        </ul>
                    </div>
                    <div class="header-top-right">
                        <ul class="header-top-list">
                            <li><a href="">Giới thiệu</a></li>
                            <li><a href="">Cửa hàng</a></li>
                            <li><a href="">Chính sách</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="header-middle">
                <div class="container">
                    <div class="header-middle-left">
                        <div class="header-logo">
                            <a href="">
                                <img src="~/assets/img/vy-food.png" alt="" class="header-logo-img">
                            </a>
                        </div>
                    </div>
                    <div class="header-middle-center">
                        <form action="" class="form-search">
                            <span class="search-btn"><i class="fa-light fa-magnifying-glass"></i></span>
                            <input type="text" class="form-search-input" placeholder="Tìm kiếm món ăn..."
                                   ng-model="data.searchText"
                                   ng-change="methods.doSearch()"
                                   @*oninput="document.getElementById('home-service').scrollIntoView({behavior: 'smooth'});"*@
                                   @*oninput="searchProducts()"*@>
                        </form>
                    </div>
                    <div class="header-middle-right">
                        <ul class="header-middle-right-list">
                            <li id="open-order-page" style="display:none"
                                ng-click="events.onOpenOrderPage()"
                                class="header-middle-right-item dropdown open">
                                <i class="fa-light fa-table-picnic"></i>
                                <p id="headerTableName"></p>
                            </li>
                            <li class="header-middle-right-item dnone open" onclick="openSearchMb();">
                                <div class="cart-icon-menu">
                                    <i class="fa-light fa-magnifying-glass"></i>
                                </div>
                            </li>
                            <li class="header-middle-right-item close" 
                                ng-click="data.searchText = '';methods.doSearch();" 
                                onclick="closeSearchMb()">
                                <div class="cart-icon-menu">
                                    <i class="fa-light fa-circle-xmark"></i>
                                </div>
                            </li>

                            <li class="header-middle-right-item cart open" ng-click="events.onOpenModelShoppingCart()" onclick="openCart()">
                                <div class="cart-icon-menu">
                                    <i class="fa-light fa-basket-shopping"></i>
                                    <span class="count-product-cart" ng-bind="data.share.shoppingCart.totalQuantity()"></span>
                                </div>
                                <span>Món đã chọn</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-cart">
                <div class="cart-container">
                    <div class="cart-header">
                        <h3 class="cart-header-title"><i class="fa-regular fa-basket-shopping-simple"></i>Các món bạn đã chọn</h3>
                        <button class="cart-close" onclick="closeCart()"><i class="fa-sharp fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="cart-body">
                        <div ng-show="data.shoppingCarts.length == 0" class="gio-hang-trong">
                            <i class="fa-thin fa-cart-xmark"></i>
                            <p>Bạn chưa chọn món nào hết á 😣</p>
                        </div>
                        <ul class="cart-list">
                            <li ng-repeat="item in data.shoppingCarts track by $index" class="cart-item">
                                <div class="cart-item-info">
                                    <p ng-bind="item.productName" class="cart-item-title">
                                    </p>
                                    <span ng-bind-html="item.productPrice | vnCurrency" class="cart-item-price price">
                                    </span>
                                </div>
                                <p class="product-note"
                                   ng-bind-html="item.shoppingCartNote == '' ? '' : '<i class=\'fa-light fa-pencil\'></i> ' + item.shoppingCartNote">
                                </p>
                                <div class="cart-item-control">
                                    <button class="cart-item-delete"
                                            ng-click="events.onDeleteShoppingCart($index)"
                                            @*onclick="deleteCartItem(3,this)"*@>
                                        Xóa
                                    </button>
                                    <div class="buttons_added">
                                        <input class="minus is-form" type="button" value="-"
                                               ng-click="events.onDecreasingNumber(item)"
                                               @*onclick="decreasingNumber(this)"*@>
                                        <input disabled ng-model="item.shoppingCartQuantity" class="input-qty" max="100" min="1" name="" type="number" value="1">
                                        <input class="plus is-form" type="button" value="+"
                                               ng-click="events.onIncreasingNumber(item)"
                                               @*onclick="increasingNumber(this)"*@>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="cart-footer">
                        <div class="cart-total-price">
                            <p class="text-tt">Tổng tiền:</p>
                            <p class="text-price" ng-bind-html="methods.shoppingCartTotalPrice() | vnCurrency"></p>
                        </div>
                        <div class="cart-footer-payment">
                            <button class="them-mon"><i class="fa-regular fa-plus"></i> Thêm món</button>
                            <button ng-class="{'disabled': data.shoppingCarts.length === 0}"
                                    ng-click="events.onOrder($event)"
                                    class="thanh-toan">
                                Gọi món
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div ng-controller="mainCtrl">
            @RenderBody()
        </div>
        <footer class="footer">
            <div class="container">
                <div class="footer-top">
                    <div class="footer-top-content">
                        <div class="footer-top-img">
                            <img src="~/assets/img/vy-food.png" alt="">
                        </div>
                        <div class="footer-top-subbox">
                            <div class="footer-top-subs">
                                <h2 class="footer-top-subs-title">Đăng ký nhận tin</h2>
                                <p class="footer-top-subs-text">Nhận thông tin mới nhất từ chúng tôi</p>
                            </div>
                            <form class="form-ground">
                                <input type="email" class="form-ground-input" placeholder="Nhập email của bạn">
                                <button class="form-ground-btn">
                                    <span>ĐĂNG KÝ</span>
                                    <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="widget-area">
                <div class="container">
                    <div class="widget-row">
                        <div class="widget-row-col-1">
                            <h3 class="widget-title">Về chúng tôi</h3>
                            <div class="widget-row-col-content">
                                @if (ViewBag.Summary == null)
                                {
                                    <p>Vy Food là thương hiệu được thành lập vào năm 2022 với tiêu chí đặt chất lượng sản phẩm lên hàng đầu.</p>
                                }
                                else
                                {
                                    <p>@ViewBag.Summary</p>
                                }
                            </div>
                            <div class="widget-social">
                                <div class="widget-social-item">
                                    <a href="">
                                        <i class="fab fa-facebook-f"></i>
                                    </a>
                                </div>
                                <div class="widget-social-item">
                                    <a href="">
                                        <i class="fab fa-twitter"></i>
                                    </a>
                                </div>
                                <div class="widget-social-item">
                                    <a href="">
                                        <i class="fab fa-linkedin-in"></i>
                                    </a>
                                </div>
                                <div class="widget-social-item">
                                    <a href="">
                                        <i class="fab fa-whatsapp"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="widget-row-col">
                            <h3 class="widget-title">Liên kết</h3>
                            <ul class="widget-contact">
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Về chúng tôi</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Thực đơn</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Điều khoản</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Liên hệ</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Tin tức</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="widget-row-col">
                            <h3 class="widget-title">Thực đơn</h3>
                            <ul class="widget-contact">
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Điểm tâm</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Món chay</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Món mặn</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Nước uống</span>
                                    </a>
                                </li>
                                <li class="widget-contact-item">
                                    <a href="">
                                        <i class="fa-regular fa-arrow-right"></i>
                                        <span>Tráng miệng</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="widget-row-col-1">
                            <h3 class="widget-title">Liên hệ</h3>
                            <div class="contact">
                                <div class="contact-item">
                                    <div class="contact-item-icon">
                                        <i class="fa-regular fa-location-dot"></i>
                                    </div>
                                    <div class="contact-content">
                                        @if (ViewBag.Address == null)
                                        {
                                            <span>11 Công trường Mê Linh, Bến Nghé, Quận 1, Hồ Chí Minh</span>
                                        }
                                        else
                                        {
                                            <span>@ViewBag.Address</span>
                                        }
                                    </div>
                                </div>
                                <div class="contact-item">
                                    <div class="contact-item-icon">
                                        <i class="fa-regular fa-phone"></i>
                                    </div>
                                    <div class="contact-content contact-item-phone">
                                        @if (ViewBag.Phone1 == null)
                                        {
                                            <span>0123 456 789</span>
                                        }
                                        else
                                        {<span>@ViewBag.Phone1</span>}
                                        <br>
                                        @if (ViewBag.Phone2 == null)
                                        {
                                            <span>9876 543 210</span>
                                        }
                                        else
                                        { <span>@ViewBag.Phone2</span>}
                                    </div>
                                </div>
                                <div class="contact-item">
                                    <div class="contact-item-icon">
                                        <i class="fa-regular fa-envelope"></i>
                                    </div>
                                    <div class="contact-content conatct-item-email">
                                        @if (ViewBag.Email1 == null)
                                        {
                                            <span>abc@domain.com</span>
                                        }
                                        else
                                        { <span>@ViewBag.Email1</span>}

                                        <br />
                                        @if (ViewBag.Email2 == null)
                                        {
                                            <span>infoabc@domain.com</span>
                                        }
                                        else
                                        { <span>@ViewBag.Email2</span>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <div class="copyright-wrap">
            <div class="container">
                <div class="copyright-content">
                    <p>Copyright 2025 goimon.shop. Phát triển dev.maicuong@gmail.com.</p>
                </div>
            </div>
        </div>
        <div class="back-to-top">
            <a href="#"><i class="fa-regular fa-arrow-up"></i></a>
        </div>
        <div id="toast"></div>
    </div>

    <script src="~/assets/js/initialization.js"></script>
    <script src="~/assets/js/main.js"></script>
    <script src="~/assets/js/checkout.js"></script>
    <script src="~/assets/js/toast-message.js"></script>
    <script>
        const app = angular.module("orderApp", ['ngSanitize', 'ngAnimate']);
    </script>
    @RenderSection("scripts_footer", required: false)
    <script>
        app.factory('ShareService', function ($http) {
            let share = {
                shoppingCart: {
                    add: function (shoppingCart) {
                        let shoppingCarts = share.shoppingCart.get() ?? [];

                        let index = shoppingCarts.findIndex(x => x.productId == shoppingCart.productId);
                        if (index > -1) {
                            shoppingCarts[index].shoppingCartQuantity += shoppingCart.shoppingCartQuantity;
                            shoppingCarts[index].shoppingCartNote += `, ${shoppingCart.shoppingCartNote}`;
                        }
                        else {
                            shoppingCarts.unshift(shoppingCart);
                        }
                        share.shoppingCart.set(shoppingCarts);
                    },
                    set: function (shoppingCarts) {
                        localStorage.setItem("shoppingCarts", JSON.stringify(shoppingCarts));
                    },
                    get: function () {
                        return JSON.parse(localStorage.getItem("shoppingCarts"));
                    },
                    clear: function () {
                        localStorage.removeItem("shoppingCarts");
                    },
                    totalQuantity: function () {
                        let totalQuantity = 0;
                        let shoppingCarts = share.shoppingCart.get() ?? [];
                        for (let item of shoppingCarts) {
                            totalQuantity += item.shoppingCartQuantity;
                        }
                        return totalQuantity;
                    }
                }
            };
            return {
                getShare: function () {
                    return share;
                }
            };
        });
    </script>
    <script>
        app.controller("headerCtrl", function ($scope, $http, $timeout, $rootScope, ShareService) {
            $scope.data = {
                share: ShareService.getShare(),
                tableId: Number(shareData.tableId) || 0,
                tableToken: shareData.tableToken,
                searchText: '',
                support: {

                }
            };
            $scope.init = function () {

            };
            $scope.events = {
                onOpenModelShoppingCart: function () {
                    $scope.data.shoppingCarts = $scope.data.share.shoppingCart.get() ?? [];
                },
                onDeleteShoppingCart: function (index) {
                    let share = ShareService.getShare();
                    $scope.data.shoppingCarts.splice(index, 1);
                    share.shoppingCart.set($scope.data.shoppingCarts);
                },
                onDecreasingNumber: function (shoppingCart) {
                    let share = ShareService.getShare();
                    shoppingCart.shoppingCartQuantity -= 1;
                    share.shoppingCart.set($scope.data.shoppingCarts);
                },
                onIncreasingNumber: function (shoppingCart) {
                    let share = ShareService.getShare();
                    shoppingCart.shoppingCartQuantity += 1;
                    share.shoppingCart.set($scope.data.shoppingCarts);
                },
                onOrder: function ($event) {
                    const button = $event.currentTarget;
                    shareData.loadButton.loading(button, true);

                    const data = {
                        order: {
                            tableId: shareData.tableId,
                            tableToken: shareData.tableToken
                        },
                        orderDetails: $scope.data.shoppingCarts
                    }
                    $scope.methods.createOrder(data, button)
                },
                onOpenOrderPage: function () {
                    const data = null;
                    $rootScope.$broadcast("OpenOrderPage", data);
                }
            }
            $scope.methods = {
                shoppingCartTotalPrice: function () {
                    if ($scope.data.shoppingCarts == null) {
                        return 0;
                    }
                    let totalPrice = 0;
                    let length = $scope.data.shoppingCarts.length
                    for (let index = 0; index < length; index++) {
                        let item = $scope.data.shoppingCarts[index];
                        totalPrice += (item.shoppingCartQuantity * item.productPrice)
                    }
                    return totalPrice;
                },
                doSearch: function () {
                    $rootScope.shareSearchText = $scope.data.searchText;
                },
                createOrder: function (data, button) {
                    $http({
                        url: '/api/home/create-order?companySlug=' + shareData.companySlug,
                        method: "POST",
                        data: data
                    })
                        .then(function (response) {
                            if (response.data.success == true) {
                                let share = ShareService.getShare();
                                share.shoppingCart.clear();
                                closeCart();
                                $scope.events.onOpenOrderPage();
                                //toast({ title: 'Success', message: 'Thêm thành công sản phẩm vào giỏ hàng', type: 'success', duration: 3000 });
                            }
                            else {
                                shareData.notification.fail(response.data.messageForUser)
                                console.error('response error', response)
                            }
                        })
                        .catch(function (response) {
                            shareData.notification.exception();
                            console.error('catch error', response);
                        })
                        .finally(function () {
                            if (button != null) {
                                shareData.loadButton.loaded(button);
                            }
                        });
                }
            };

            $scope.init();
        });
    </script>
    <script>
        //filter Dùng chung angularjs
        app.filter('vnCurrency', function () {
            return function (input) {
                if (isNaN(input)) {
                    return '0'; // Giá trị mặc định nếu input không hợp lệ
                }
                return parseFloat(input)
                    .toFixed(0) // Làm tròn đến số nguyên
                    .replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '&nbsp;₫'; // Thêm dấu chấm phân cách hàng nghìn
            };
        });
        app.filter('vnNumber', function () {
            return function (input) {
                if (isNaN(input)) {
                    return '0'; // Giá trị mặc định nếu input không hợp lệ
                }
                return parseFloat(input)
                    .toFixed(0) // Làm tròn đến số nguyên
                    .replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // Thêm dấu chấm phân cách hàng nghìn
            };
        });
        app.directive('formatPhoneInput', ['$filter', function ($filter) {
            return {
                restrict: 'A',
                require: 'ngModel',
                link: function (scope, element, attrs, ngModelCtrl) {
                    function formatPhoneNumber(value) {
                        if (!value) return '';
                        var cleaned = value.replace(/\D/g, ''); // bỏ ký tự không phải số

                        // Định dạng 4-3-3 (VD: 0123-345-678)
                        if (cleaned.length <= 4) {
                            return cleaned;
                        } else if (cleaned.length <= 7) {
                            return cleaned.slice(0, 4) + '-' + cleaned.slice(4);
                        } else {
                            return cleaned.slice(0, 4) + '-' + cleaned.slice(4, 7) + '-' + cleaned.slice(7, 10);
                        }
                    }

                    ngModelCtrl.$parsers.push(function (value) {
                        var formatted = formatPhoneNumber(value || '');
                        ngModelCtrl.$setViewValue(formatted);
                        ngModelCtrl.$render();
                        return formatted.replace(/\D/g, ''); // trả về chuỗi số thuần cho model
                    });

                    element.on('input', function () {
                        var value = element.val();
                        var formatted = formatPhoneNumber(value);
                        ngModelCtrl.$setViewValue(formatted);
                        ngModelCtrl.$render();
                    });
                }
            };
        }]);
    </script>
    <script>
        // đặt lại chiều cao khi botton màn hình bị che trên dt iphone
        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setVH);
        setVH();
    </script>
</body>
</html>