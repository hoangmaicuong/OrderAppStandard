@using System.Configuration;
@{
    ViewBag.Title = "Order App";
}
@section css_header{
    <style>
        .active-link {
            border-bottom: 3px solid var(--red);
        }
    </style>
}
@section scripts_header{
    <script>
        const context = {
            tableId: '@ViewBag.TableId',
            tableToken: '@ViewBag.TableToken',
            companySlug: '@ViewBag.CompanySlug',
            imagePath: '@ConfigurationManager.AppSettings["ProductImageUploadPath"]'
        }
    </script>
}
<nav class="header-bottom">
    <div class="container">
        <ul class="menu-list">
            <li class="menu-list-item" ng-class="{'active-link': data.filter.categoryId == null}">
                <a href="javascript:;"
                   ng-click="events.onFilterByCategory(null)"
                   class="menu-link">Tất cả các món</a>
            </li>
            <li ng-repeat="cat in data.support.categorys | orderBy:'no'"
                ng-class="{'active-link': data.filter.categoryId == cat.categoryId}"
                class="menu-list-item">
                <a ng-bind="cat.categoryName" href="javascript:;"
                   ng-click="events.onFilterByCategory(cat.categoryId)"
                   class="menu-link"></a>
            </li>
        </ul>
    </div>
</nav>

<main class="main-wrapper">
    <div class="container" id="trangchu">
        <div class="home-slider">
            <img src="~/assets/img/banner-1.png" alt="">
            <!-- <img src="~/assets/img/banner-2.png" alt="">
        <img src="~/assets/img/banner-3.png" alt="">
        <img src="~/assets/img/banner-4.png" alt="">
        <img src="~/assets/img/banner-5.png" alt=""> -->
        </div>
        <div class="home-service" id="home-service">
            <div class="home-service-item">
                <div class="home-service-item-icon">
                    <i class="fa-light fa-person-carry-box"></i>
                </div>
                <div class="home-service-item-content">
                    <h4 class="home-service-item-content-h">GIAO HÀNG NHANH</h4>
                    <p class="home-service-item-content-desc">Cho tất cả đơn hàng</p>
                </div>
            </div>
            <div class="home-service-item">
                <div class="home-service-item-icon">
                    <i class="fa-light fa-shield-heart"></i>
                </div>
                <div class="home-service-item-content">
                    <h4 class="home-service-item-content-h">SẢN PHẨM AN TOÀN</h4>
                    <p class="home-service-item-content-desc">Cam kết chất lượng</p>
                </div>
            </div>
            <div class="home-service-item">
                <div class="home-service-item-icon">
                    <i class="fa-light fa-headset"></i>
                </div>
                <div class="home-service-item-content">
                    <h4 class="home-service-item-content-h">HỖ TRỢ 24/7</h4>
                    <p class="home-service-item-content-desc">Tất cả ngày trong tuần</p>
                </div>
            </div>
            <div class="home-service-item">
                <div class="home-service-item-icon">
                    <i class="fa-light fa-circle-dollar"></i>
                </div>
                <div class="home-service-item-content">
                    <h4 class="home-service-item-content-h">HOÀN LẠI TIỀN</h4>
                    <p class="home-service-item-content-desc">Nếu không hài lòng</p>
                </div>
            </div>
        </div>
        <div class="home-title-block" id="home-title">
            <h2 class="home-title">Khám phá thực đơn của chúng tôi</h2>
        </div>
        <div class="home-products" id="home-products">
            <div class="no-result" ng-if="filteredProducts.length === 0">
                <div class="no-result-h">Tìm kiếm không có kết quả</div>
                <div class="no-result-p">Xin lỗi, chúng tôi không thể tìm được kết quả hợp với tìm kiếm của bạn</div>
                <div class="no-result-i">
                    <i class="fa-light fa-face-sad-cry"></i>
                </div>
            </div>
            <div ng-repeat="item in filteredProducts = (data.products | filter: methods.productFilter | filter: data.filter.searchText)" class="col-product">
                <article class="card-product">
                    <div class="card-header">
                        <a href="javascript:;" class="card-image-link" ng-click="events.onOpenModelProduct(item)">
                            <img class="card-image" ng-src="{{item.fileId ? data.support.imagePath + item.fileId : '/assets/img/blank-image.png'}}" alt="">
                        </a>
                    </div>
                    <div class="food-info">
                        <div class="card-content">
                            <div class="card-title">
                                <a href="javascript:;" ng-bind-html="item.productName"
                                   class="card-title-link" ng-click="events.onOpenModelProduct(item)" @*onclick="detailProduct(1)"*@></a>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="product-price">
                                <span ng-bind-html="item.productPrice | vnCurrency" class="current-price"></span>
                            </div>
                            <div class="product-buy">
                                <button type="button" ng-click="events.onOpenModelProduct(item)" class="card-button order-item"><i class="fa-regular fa-cart-shopping-fast"></i> Đặt món</button>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </div>
        <div class="page-nav">
            <ul class="page-nav-list">
            </ul>
        </div>
    </div>
    <div class="container" id="account-user">
        <div class="main-account">
            <div class="main-account-header">
                <h3>Thông tin tài khoản của bạn</h3>
                <p>Quản lý thông tin để bảo mật tài khoản</p>
            </div>
            <div class="main-account-body">
                <div class="main-account-body-col">
                    <form action="" class="info-user">
                        <div class="form-group">
                            <label for="infoname" class="form-label">Họ và tên</label>
                            <input class="form-control" type="text" name="infoname" id="infoname" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="infophone" class="form-label">Số điện thoại</label>
                            <input class="form-control" type="text" name="infophone" id="infophone" disabled="true"
                                   placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="infoemail" class="form-label">Email</label>
                            <input class="form-control" type="email" name="infoemail" id="infoemail"
                                   placeholder="Thêm địa chỉ email của bạn">
                            <span class="inforemail-error form-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="infoaddress" class="form-label">Địa chỉ</label>
                            <input class="form-control" type="text" name="infoaddress" id="infoaddress"
                                   placeholder="Thêm địa chỉ giao hàng của bạn">
                        </div>
                    </form>
                </div>
                <div class="main-account-body-col">
                    <form action="" class="change-password">
                        <div class="form-group">
                            <label for="" class="form-label w60">Mật khẩu hiện tại</label>
                            <input class="form-control" type="password" name="" id="password-cur-info"
                                   placeholder="Nhập mật khẩu hiện tại">
                            <span class="password-cur-info-error form-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="" class="form-label w60">Mật khẩu mới </label>
                            <input class="form-control" type="password" name="" id="password-after-info"
                                   placeholder="Nhập mật khẩu mới">
                            <span class="password-after-info-error form-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="" class="form-label w60">Xác nhận mật khẩu mới</label>
                            <input class="form-control" type="password" name="" id="password-comfirm-info"
                                   placeholder="Nhập lại mật khẩu mới">
                            <span class="password-after-comfirm-error form-message"></span>
                        </div>
                    </form>
                </div>
                <div class="main-account-body-row">
                    <div>
                        <button id="save-info-user" onclick="changeInformation()">
                            <i class="fa-regular fa-floppy-disk"></i> Lưu thay đổi
                        </button>
                    </div>
                    <div>
                        <button id="save-password" onclick="changePassword()">
                            <i class="fa-regular fa-key"></i> Đổi
                            mật khẩu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="order-history">
        <div class="main-account">
            <div class="main-account-header">
                <h3>Đơn Đặt {{data.table.tableName}}</h3>
                <p>Chi tiết và trạng thái của những đơn hàng đã đặt cho bàn này.</p>
            </div>
            <div ng-if="data.orders.length == 0" class="main-account-body">
                <div class="order-history-section"><div class="empty-order-section"><img src="./assets/img/empty-order.jpg" alt="" class="empty-order-img"><p>Chưa có đơn hàng nào</p></div></div>
            </div>
            <div class="main-account-body">
                <div class="order-history-section">
                    <div ng-repeat="order in data.orders" class="order-history-group">
                        <div ng-repeat="detail in order.orderDetails" class="order-history">
                            <div class="order-history-left">
                                <img ng-src="{{detail.fileId ? data.support.imagePath + detail.fileId : '/assets/img/blank-image.png'}}" alt="">
                                <div class="order-history-info">
                                    <h4 ng-bind="detail.productName"></h4>
                                    <p ng-bind-html="detail.orderDetailNote || '<i class=\'fa-light fa-pen\'></i> Không có ghi chú'" class="order-history-note"></p>
                                    <p ng-bind="'x' + detail.orderDetailQuantity" class="order-history-quantity"></p>
                                </div>
                            </div>
                            <div class="order-history-right">
                                <div class="order-history-price">
                                    <span ng-bind-html="detail.productPrice | vnCurrency" class="order-history-current-price"></span>
                                </div>
                            </div>
                        </div>

                        <div class="order-history-control">
                            <div class="order-history-status">
                                <span ng-show="order.isConfirm != true" class="order-history-status-sp" style="background-color: #f04e2e; color: var(--white);">
                                    <i class="fa-solid fa-loader fa-spin fa-spin-reverse"></i>
                                    đang xác nhận
                                </span>
                                <span ng-show="order.isConfirm == true" class="order-history-status-sp complete">
                                    đã xác nhận
                                </span>
                            </div>
                            <div class="order-history-total">
                                <span class="order-history-total-desc">Tổng tiền: </span>
                                <span ng-bind-html="methods.calculateOrderTotal(order) | vnCurrency" class="order-history-toltal-price"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div class="modal product-detail">
    <button class="modal-close close-popup"><i class="fa-thin fa-xmark"></i></button>
    @*<div class="modal-container mdl-cnt" id="product-detail-content">
        </div>*@
    <div class="modal-container mdl-cnt" id="product-detail-content">
        <div class="modal-header">
            <img class="product-image" ng-src="{{data.shoppingCart.fileId ? data.support.imagePath + data.shoppingCart.fileId : '/assets/img/blank-image.png'}}"  alt="">
        </div>
        <div class="modal-body">
            <h2 class="product-title">{{data.shoppingCart.productName}}</h2>
            <div class="product-control">
                <div class="priceBox">
                    <span class="current-price" ng-bind-html="data.shoppingCart.productPrice | vnCurrency"></span>
                </div>
                <div class="buttons_added">
                    <input class="minus is-form" type="button" value="-"
                           ng-click="data.shoppingCart.shoppingCartQuantity = data.shoppingCart.shoppingCartQuantity - 1"
                           @*onclick="decreasingNumber(this)"*@>
                    <input disabled ng-model="data.shoppingCart.shoppingCartQuantity" class="input-qty" max="100" min="1" name="" type="number" value="1">
                    <input class="plus is-form" type="button" value="+"
                           ng-click="data.shoppingCart.shoppingCartQuantity = data.shoppingCart.shoppingCartQuantity + 1"
                           @*onclick="increasingNumber(this)"*@>
                </div>
            </div>
            <p class="product-description">{{data.shoppingCart.productDescription}}</p>
        </div>
        <div class="notebox">
            <p class="notebox-title">Ghi chú</p>
            <textarea class="text-note" ng-model="data.shoppingCart.shoppingCartNote" id="popup-detail-note" placeholder="Nhập thông tin cần lưu ý..."></textarea>
        </div>
        <div class="modal-footer">
            <div class="price-total">
                <span class="thanhtien">Thành tiền</span>
                <span class="price" ng-bind-html="(data.shoppingCart.productPrice * data.shoppingCart.shoppingCartQuantity) | vnCurrency"></span>
            </div>
            <div class="modal-footer-control">
                @*<button class="button-dathangngay" data-product="1">Đặt hàng ngay</button>*@
                <button class="button-dat" id="add-cart" onclick="animationCart()"
                        ng-click="events.onAddShoppingCart($event)"
                        >
                    Chọn món này <i class="fa-light fa-basket-shopping"></i>
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal signup-login">
    <div class="modal-container">
        <button class="form-close" onclick="closeModal()"><i class="fa-regular fa-xmark"></i></button>
        <div class="forms mdl-cnt">
            <div class="form-content sign-up">
                <h3 class="form-title">
                    Đăng ký tài khoản
                </h3>
                <p class="form-description">
                    Đăng ký thành viên để mua hàng và nhận những ưu đãi đặc biệt từ chúng
                    tôi
                </p>
                <form action="" class="signup-form">
                    <div class="form-group">
                        <label for="fullname" class="form-label">Tên đầy đủ</label>
                        <input id="fullname" name="fullname" type="text" placeholder="VD: Nhật Sinh"
                               class="form-control">
                        <span class="form-message-name form-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="phone" class="form-label">Số điện thoại</label>
                        <input id="phone" name="phone" type="text" placeholder="Nhập số điện thoại"
                               class="form-control">
                        <span class="form-message-phone form-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Mật khẩu</label>
                        <input id="password" name="password" type="password" placeholder="Nhập mật khẩu"
                               class="form-control">
                        <span class="form-message-password form-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="password_confirmation" class="form-label">Nhập lại mật khẩu</label>
                        <input id="password_confirmation" name="password_confirmation"
                               placeholder="Nhập lại mật khẩu" type="password" class="form-control">
                        <span class="form-message-password-confi form-message"></span>
                    </div>
                    <div class="form-group">
                        <input class="checkbox" name="checkbox" required="" type="checkbox" id="checkbox-signup">
                        <label for="checkbox-signup" class="form-checkbox">
                            Tôi đồng ý với <a href="#"
                                              title="chính sách trang web" target="_blank">chính sách trang web</a>
                        </label>
                        <p class="form-message-checkbox form-message"></p>
                    </div>
                    <button class="form-submit" id="signup-button">Đăng ký</button>
                </form>
                <p class="change-login">
                    Bạn đã có tài khoản ? <a href="javascript:;" class="login-link">
                        Đăng nhập
                        ngay
                    </a>
                </p>
            </div>
            <div class="form-content login">
                <h3 class="form-title">Đăng nhập tài khoản</h3>
                <p class="form-description">
                    Đăng nhập thành viên để mua hàng và nhận những ưu đãi đặc biệt từ chúng
                    tôi
                </p>
                <form action="" class="login-form">
                    <div class="form-group">
                        <label for="phone" class="form-label">Số điện thoại</label>
                        <input id="phone-login" name="phone" type="text" placeholder="Nhập số điện thoại"
                               class="form-control">
                        <span class="form-message phonelog"></span>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Mật khẩu</label>
                        <input id="password-login" name="password" type="password" placeholder="Nhập mật khẩu"
                               class="form-control">
                        <span class="form-message-check-login form-message"></span>
                    </div>
                    <button class="form-submit" id="login-button">Đăng nhập</button>
                </form>
                <p class="change-login">
                    Bạn chưa có tài khoản ? <a href="javascript:;" class="signup-link">
                        Đăng kí
                        ngay
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

@section scripts_footer {
    <script>
        app.controller("mainCtrl", function ($scope, $http, $rootScope, ShareService) {
            $scope.data = {
                product: {},
                shoppingCart: {},
                share: ShareService.getShare(),
                support: {
                    imagePath: context.imagePath,
                },
                filter: {
                    categoryId: null,
                    searchText: ''
                }
            }

            $scope.init = function () {
                $scope.methods.loadInit();
                if (context.tableId > 0 && context.tableToken != '') {
                    $scope.methods.getTable(context.tableId, context.tableToken);
                }
            };

            $scope.$watch(function () {
                return $rootScope.shareSearchText;
            }, function (newVal) {
                $scope.data.filter.searchText = newVal;

                document.getElementById('trangchu').classList.remove('hide');
                document.getElementById('order-history').classList.remove('open');

                if ($scope.data.filter.categoryId == 0) {
                    $scope.data.filter.categoryId = null; // null là hiển thị hết
                }
            });
            $scope.$on("OpenOrderPage", function (event, data) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                document.getElementById('trangchu').classList.add('hide');
                $scope.methods.getOrderOfTable(context.tableId, context.tableToken);
                document.getElementById('order-history').classList.add('open');

                $scope.data.filter.categoryId = 0; // 0 là ko hiển thị
            });

            $scope.events = {
                onOpenModelProduct: function (product) {
                    $scope.data.shoppingCart = product;
                    $scope.data.shoppingCart.shoppingCartQuantity = 1;
                    $scope.data.shoppingCart.shoppingCartNote = '';

                    document.querySelector(".modal.product-detail").classList.add("open");
                    body.style.overflow = "hidden";
                },
                onAddShoppingCart: function ($event) {
                    //const button = $event.currentTarget;
                    //shareData.loadButton.loading(button);
                    $scope.data.share.shoppingCart.add($scope.data.shoppingCart);
                    closeModal();
                },
                onFilterByCategory: function (categoryId) {
                    document.getElementById('trangchu').classList.remove('hide');
                    document.getElementById('order-history').classList.remove('open');

                    $scope.data.filter.categoryId = categoryId;
                    document.getElementById("home-title").scrollIntoView();
                }
            };
            $scope.methods = {
                loadInit: function () {
                    $http({
                        url: '/api/home/get-all?companySlug=' + context.companySlug,
                        method: "Get"
                    })
                    .then(function (response) {
                        //console.log('response', response);
                        $scope.data.products = response.data.products;
                        $scope.data.support.categorys = response.data.categorys;
                    })
                    .catch(function (response) {
                        shareData.notification.exception();
                        console.error('catch error', response);
                    })
                    .finally(function () {


                    });
                },
                getTable: function (tableId, tableToken) {
                    $http({
                        url: `/api/home/get-table?tableId=${tableId}&tableToken=${tableToken}`,
                        method: "Get"
                    })
                    .then(function (response) {
                        //console.log('response', response);
                        $scope.data.table = response.data.tables[0];

                    })
                    .catch(function (response) {
                        shareData.notification.exception();
                        console.error('catch error', response);
                    })
                    .finally(function () {


                    });
                },
                productFilter: function (product) {
                    if ($scope.data.filter.categoryId == null) return true;
                    return product.categoryId == $scope.data.filter.categoryId;
                },
                getOrderOfTable: function (tableId, tableToken) {
                    let liTag = document.getElementById("open-order-page");
                    let liTagHtmlRoot = liTag.innerHTML;
                    liTag.innerHTML = '<i class="fa-solid fa-loader fa-spin fa-spin-reverse"></i>';

                    $http({
                        url: `/api/home/get-order-of-table?tableId=${tableId}&tableToken=${tableToken}`,
                        method: "Get"
                    })
                    .then(function (response) {
                        //console.log('response', response);
                        let orders = response.data.orders.map(function (order) {
                            return {
                                ...order,
                                orderDetails: response.data.orderDetails.filter(d => d.orderId === order.orderId)
                            };
                        });

                        $scope.data.orders = orders;
                        //console.log('orders', orders);
                    })
                    .catch(function (response) {
                        shareData.notification.exception();
                        console.error('catch error', response);
                    })
                    .finally(function () {
                        liTag.innerHTML = liTagHtmlRoot;
                    });
                },
                calculateOrderTotal: function (order) {
                    if (!order || !order.orderDetails) return 0;
                    return order.orderDetails.reduce(function (total, detail) {
                        return total + (detail.productPrice * detail.orderDetailQuantity);
                    }, 0);
                }
            };
            $scope.init();
        });
    </script>
}