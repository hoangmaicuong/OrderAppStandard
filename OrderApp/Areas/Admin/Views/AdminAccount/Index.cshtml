
@{
    ViewBag.Title = "Tài khoản";
    var currentController = ViewContext.RouteData.Values["controller"].ToString();
}


<div class="section">
    <div class="admin-control">
        <div class="admin-control-left">
            <select name="tinh-trang-user" id="tinh-trang-user" onchange="showUser()">
                <option value="2">Tất cả</option>
                <option value="1">Hoạt động</option>
                <option value="0">Bị khóa</option>
            </select>
        </div>
        <div class="admin-control-center">
            <form action="" class="form-search">
                <span class="search-btn"><i class="fa-light fa-magnifying-glass"></i></span>
                <input id="form-search-user" type="text" class="form-search-input" placeholder="Tìm kiếm khách hàng..." oninput="showUser()">
            </form>
        </div>
        <div class="admin-control-right">
            <form action="" class="fillter-date">
                <div>
                    <label for="time-start">Từ</label>
                    <input type="date" class="form-control-date" id="time-start-user" onchange="showUser()">
                </div>
                <div>
                    <label for="time-end">Đến</label>
                    <input type="date" class="form-control-date" id="time-end-user" onchange="showUser()">
                </div>
            </form>
            <button class="btn-reset-order" onclick="cancelSearchUser()"><i class="fa-light fa-arrow-rotate-right"></i></button>
            <button id="btn-add-user" class="btn-control-large" onclick="openCreateAccount()"><i class="fa-light fa-plus"></i> <span>Thêm khách hàng</span></button>
        </div>
    </div>
    <div class="table">
        <table width="100%">
            <thead>
                <tr>
                    <td>STT</td>
                    <td>Họ và tên</td>
                    <td>Liên hệ</td>
                    <td>Ngày tham gia</td>
                    <td>Tình trạng</td>
                    <td></td>
                </tr>
            </thead>
            <tbody id="show-user">
            </tbody>
        </table>
    </div>
    <!-- </div> -->
</div>

<script>

    function showUserArr(arr) {
        let accountHtml = '';
        if (arr.length == 0) {
            accountHtml = `<td colspan="5">Không có dữ liệu</td>`
        } else {
            arr.forEach((account, index) => {
                let tinhtrang = account.status == 0 ? `<span class="status-no-complete">Bị khóa</span>` : `<span class="status-complete">Hoạt động</span>`;
                accountHtml += ` <tr>
            <td>${index + 1}</td>
            <td>${account.fullname}</td>
            <td>${account.phone}</td>
            <td>${formatDate(account.join)}</td>
            <td>${tinhtrang}</td>
            <td class="control control-table">
            <button class="btn-edit" id="edit-account" onclick='editAccount(${account.phone})' ><i class="fa-light fa-pen-to-square"></i></button>
            <button class="btn-delete" id="delete-account" onclick="deleteAcount(${index})"><i class="fa-regular fa-trash"></i></button>
            </td>
        </tr>`
            })
        }
        document.getElementById('show-user').innerHTML = accountHtml;
    }
    function showUser() {
        let tinhTrang = parseInt(document.getElementById("tinh-trang-user").value);
        let ct = document.getElementById("form-search-user").value;
        let timeStart = document.getElementById("time-start-user").value;
        let timeEnd = document.getElementById("time-end-user").value;

        if (timeEnd < timeStart && timeEnd != "" && timeStart != "") {
            alert("Lựa chọn thời gian sai !");
            return;
        }

        let accounts = localStorage.getItem("accounts") ? JSON.parse(localStorage.getItem("accounts")).filter(item => item.userType == 0) : [];
        let result = tinhTrang == 2 ? accounts : accounts.filter(item => item.status == tinhTrang);

        result = ct == "" ? result : result.filter((item) => {
            return (item.fullname.toLowerCase().includes(ct.toLowerCase()) || item.phone.toString().toLowerCase().includes(ct.toLowerCase()));
        });

        if (timeStart != "" && timeEnd == "") {
            result = result.filter((item) => {
                return new Date(item.join) >= new Date(timeStart).setHours(0, 0, 0);
            });
        } else if (timeStart == "" && timeEnd != "") {
            result = result.filter((item) => {
                return new Date(item.join) <= new Date(timeEnd).setHours(23, 59, 59);
            });
        } else if (timeStart != "" && timeEnd != "") {
            result = result.filter((item) => {
                return (new Date(item.join) >= new Date(timeStart).setHours(0, 0, 0) && new Date(item.join) <= new Date(timeEnd).setHours(23, 59, 59)
                );
            });
        }
        showUserArr(result);
    }
    window.onload = showUser();
    // Format Date
    function formatDate(date) {
        let fm = new Date(date);
        let yyyy = fm.getFullYear();
        let mm = fm.getMonth() + 1;
        let dd = fm.getDate();
        if (dd < 10) dd = "0" + dd;
        if (mm < 10) mm = "0" + mm;
        return dd + "/" + mm + "/" + yyyy;
    }
    function cancelSearchUser() {
        let accounts = localStorage.getItem("accounts") ? JSON.parse(localStorage.getItem("accounts")).filter(item => item.userType == 0) : [];
        showUserArr(accounts);
        document.getElementById("tinh-trang-user").value = 2;
        document.getElementById("form-search-user").value = "";
        document.getElementById("time-start-user").value = "";
        document.getElementById("time-end-user").value = "";
    }
</script>