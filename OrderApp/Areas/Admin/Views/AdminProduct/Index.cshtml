@using System.Configuration;
@{
    ViewBag.Title = "Sản phẩm";
}
@section css_header{

}
@section scripts_header{
    <script>
        const context = {
            imagePath: '@ConfigurationManager.AppSettings["ProductImageUploadPath"]'
        }
    </script>
}
<div class="section product-all">
    <div class="admin-control">
        <div class="admin-control-left">
            <select name="the-loai" id="the-loai" onchange="showProduct()">
                <option>Tất cả</option>
                <option>Món chay</option>
                <option>Món mặn</option>
                <option>Món lẩu</option>
                <option>Món ăn vặt</option>
                <option>Món tráng miệng</option>
                <option>Nước uống</option>
                <option>Đã xóa</option>
            </select>
        </div>
        <div class="admin-control-center">
            <form action="" class="form-search">
                <span class="search-btn"><i class="fa-light fa-magnifying-glass"></i></span>
                <input id="form-search-product" type="text" class="form-search-input" placeholder="Tìm kiếm tên món..." oninput="showProduct()">
            </form>
        </div>
        <div class="admin-control-right">
            <button class="btn-control-large" id="btn-cancel-product" onclick="cancelSearchProduct()"><i class="fa-light fa-rotate-right"></i> Làm mới</button>
            <button class="btn-control-large" id="btn-add-product"><i class="fa-light fa-plus"></i> Thêm món mới</button>
        </div>
    </div>
    <div id="show-product"></div>
    <div class="page-nav">
        <ul class="page-nav-list">
        </ul>
    </div>
</div>
@*Model add-product*@
<div class="modal add-product">
    <div class="modal-container">
        <h3 class="modal-container-title add-product-e">THÊM MỚI SẢN PHẨM</h3>
        <h3 class="modal-container-title edit-product-e">CHỈNH SỬA SẢN PHẨM</h3>
        <button class="modal-close product-form"><i class="fa-regular fa-xmark"></i></button>
        <div class="modal-content">
            <form action="" class="add-product-form">
                <div class="modal-content-left">
                    <img src="/assets/img/blank-image.png" alt="" class="upload-image-preview">
                    <div class="form-group file">
                        <label for="up-hinh-anh" class="form-label-file"><i class="fa-regular fa-cloud-arrow-up"></i>Chọn hình ảnh</label>
                        <input accept="image/jpeg, image/png, image/jpg" 
                               ng-click="methods.checkBeforeUpload($event)"
                               id="up-hinh-anh" 
                               name="up-hinh-anh" 
                               type="file" 
                               class="form-control" 
                               onchange="uploadImage(this)">
                    </div>
                </div>
                <div class="modal-content-right">
                    <div class="form-group">
                        <label for="ten-mon" class="form-label">Tên món</label>
                        <input  ng-model="data.product.productName" id="ten-mon" name="ten-mon" type="text" placeholder="Nhập tên món"
                               class="form-control">
                        <span class="form-message"></span>
                    </div>
                    <div class="form-group edit-account-e">
                        <label for="" class="form-label">Trạng thái</label>
                        <input ng-model="data.product.isActive" type="checkbox" id="user-status" class="switch-input">
                        <label for="user-status" class="switch"></label>
                    </div>
                    <div class="form-group">
                        <label for="category" class="form-label">Chọn món</label>
                        <select ng-model="data.product.categoryId"
                                ng-options="c.categoryId as c.categoryName for c in data.support.categorys">
                        </select>
                        <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="gia-moi" class="form-label">Giá bán</label>
                        <input  ng-model="data.product.productPrice" id="gia-moi" name="gia-moi" type="text" placeholder="Nhập giá bán"
                               class="form-control">
                        <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="mo-ta" class="form-label">Mô tả</label>
                        <textarea  ng-model="data.product.productDescription" class="product-desc" id="mo-ta" placeholder="Nhập mô tả món ăn..."></textarea>
                        <span class="form-message"></span>
                    </div>
                    <button ng-click="events.onAdd($event)" class="form-submit btn-add-product-form add-product-e" @*id="add-product-button"*@>
                        <span>LƯU THAY ĐỔI</span>
                    </button>
                    @*<button class="form-submit btn-update-product-form edit-product-e" id="update-product-button">
                        <i class="fa-light fa-pencil"></i>
                        <span>LƯU THAY ĐỔI</span>
                    </button>*@
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // Doi sang dinh dang tien VND
    function vnd(price) {
        return price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }
    // Phân trang
    let perPage = 12;
    let currentPage = 1;
    let totalPage = 0;
    let perProducts = [];

    function displayList(productAll, perPage, currentPage) {
        let start = (currentPage - 1) * perPage;
        let end = (currentPage - 1) * perPage + perPage;
        let productShow = productAll.slice(start, end);
        showProductArr(productShow);
    }

    function setupPagination(productAll, perPage) {
        document.querySelector('.page-nav-list').innerHTML = '';
        let page_count = Math.ceil(productAll.length / perPage);
        for (let i = 1; i <= page_count; i++) {
            let li = paginationChange(i, productAll, currentPage);
            document.querySelector('.page-nav-list').appendChild(li);
        }
    }

    function paginationChange(page, productAll, currentPage) {
        let node = document.createElement(`li`);
        node.classList.add('page-nav-item');
        node.innerHTML = `<a href="#">${page}</a>`;
        if (currentPage == page) node.classList.add('active');
        node.addEventListener('click', function () {
            currentPage = page;
            displayList(productAll, perPage, currentPage);
            let t = document.querySelectorAll('.page-nav-item.active');
            for (let i = 0; i < t.length; i++) {
                t[i].classList.remove('active');
            }
            node.classList.add('active');
        })
        return node;
    }

    // Hiển thị danh sách sản phẩm
    function showProductArr(arr) {
        let productHtml = "";
        if (arr.length == 0) {
            productHtml = `<div class="no-result"><div class="no-result-i"><i class="fa-light fa-face-sad-cry"></i></div><div class="no-result-h">Không có sản phẩm để hiển thị</div></div>`;
        } else {
            arr.forEach(product => {
                let btnCtl = product.status == 1 ?
                    `<button class="btn-delete" onclick="deleteProduct(${product.id})"><i class="fa-regular fa-trash"></i></button>` :
                    `<button class="btn-delete" onclick="changeStatusProduct(${product.id})"><i class="fa-regular fa-eye"></i></button>`;
                productHtml += `
            <div class="list">
                    <div class="list-left">
                    <img src="${product.img}" alt="">
                    <div class="list-info">
                        <h4>${product.title}</h4>
                        <p class="list-note">${product.desc}</p>
                        <span class="list-category">${product.category}</span>
                    </div>
                </div>
                <div class="list-right">
                    <div class="list-price">
                    <span class="list-current-price">${vnd(product.price)}</span>
                    </div>
                    <div class="list-control">
                    <div class="list-tool">
                        <button class="btn-edit" onclick="editProduct(${product.id})"><i class="fa-light fa-pen-to-square"></i></button>
                        ${btnCtl}
                    </div>
                </div>
                </div>
            </div>`;
            });
        }
        document.getElementById("show-product").innerHTML = productHtml;
    }

    function showProduct() {
        let selectOp = document.getElementById('the-loai').value;
        let valeSearchInput = document.getElementById('form-search-product').value;
        let products = localStorage.getItem("products") ? JSON.parse(localStorage.getItem("products")) : [];

        if (selectOp == "Tất cả") {
            result = products.filter((item) => item.status == 1);
        } else if (selectOp == "Đã xóa") {
            result = products.filter((item) => item.status == 0);
        } else {
            result = products.filter((item) => item.category == selectOp);
        }

        result = valeSearchInput == "" ? result : result.filter(item => {
            return item.title.toString().toUpperCase().includes(valeSearchInput.toString().toUpperCase());
        })

        displayList(result, perPage, currentPage);
        setupPagination(result, perPage, currentPage);
    }

    function cancelSearchProduct() {
        let products = localStorage.getItem("products") ? JSON.parse(localStorage.getItem("products")).filter(item => item.status == 1) : [];
        document.getElementById('the-loai').value = "Tất cả";
        document.getElementById('form-search-product').value = "";
        displayList(products, perPage, currentPage);
        setupPagination(products, perPage, currentPage);
    }

    window.onload = showProduct();
    // Open Popup Modal
    let btnAddProduct = document.getElementById("btn-add-product");
    btnAddProduct.addEventListener("click", () => {
        document.querySelectorAll(".add-product-e").forEach(item => {
            item.style.display = "block";
        })
        document.querySelectorAll(".edit-product-e").forEach(item => {
            item.style.display = "none";
        })
        document.querySelector(".add-product").classList.add("open");
    });

    //let btnAddProductIn = document.getElementById("add-product-button");
    //btnAddProductIn.addEventListener("click", (e) => {
    //    e.preventDefault();
    //    let imgProduct = getPathImage(document.querySelector(".upload-image-preview").src)
    //    let tenMon = document.getElementById("ten-mon").value;
    //    let price = document.getElementById("gia-moi").value;
    //    let moTa = document.getElementById("mo-ta").value;
    //    let categoryText = document.getElementById("chon-mon").value;
    //    if (tenMon == "" || price == "" || moTa == "") {
    //        toast({ title: "Chú ý", message: "Vui lòng nhập đầy đủ thông tin món!", type: "warning", duration: 3000, });
    //    } else {
    //        if (isNaN(price)) {
    //            toast({ title: "Chú ý", message: "Giá phải ở dạng số!", type: "warning", duration: 3000, });
    //        } else {
    //            let products = localStorage.getItem("products") ? JSON.parse(localStorage.getItem("products")) : [];
    //            let product = {
    //                id: createId(products),
    //                title: tenMon,
    //                img: imgProduct,
    //                category: categoryText,
    //                price: price,
    //                desc: moTa,
    //                status: 1
    //            };
    //            products.unshift(product);
    //            localStorage.setItem("products", JSON.stringify(products));
    //            showProduct();
    //            document.querySelector(".add-product").classList.remove("open");
    //            toast({ title: "Success", message: "Thêm sản phẩm thành công!", type: "success", duration: 3000 });
    //            setDefaultValue();
    //        }
    //    }
    //});

    //document.querySelector(".modal-close.product-form").addEventListener("click", () => {
    //    setDefaultValue();
    //})

    //function setDefaultValue() {
    //    document.querySelector(".upload-image-preview").src = "~/assets/img/blank-image.png";
    //    document.getElementById("ten-mon").value = "";
    //    document.getElementById("gia-moi").value = "";
    //    document.getElementById("mo-ta").value = "";
    //    document.getElementById("chon-mon").value = "Món chay";
    //}

    //let btnUpdateProductIn = document.getElementById("update-product-button");
    //btnUpdateProductIn.addEventListener("click", (e) => {
    //    e.preventDefault();
    //    let products = JSON.parse(localStorage.getItem("products"));
    //    let idProduct = products[indexCur].id;
    //    let imgProduct = products[indexCur].img;
    //    let titleProduct = products[indexCur].title;
    //    let curProduct = products[indexCur].price;
    //    let descProduct = products[indexCur].desc;
    //    let categoryProduct = products[indexCur].category;
    //    let imgProductCur = getPathImage(document.querySelector(".upload-image-preview").src)
    //    let titleProductCur = document.getElementById("ten-mon").value;
    //    let curProductCur = document.getElementById("gia-moi").value;
    //    let descProductCur = document.getElementById("mo-ta").value;
    //    let categoryText = document.getElementById("chon-mon").value;

    //    if (imgProductCur != imgProduct || titleProductCur != titleProduct || curProductCur != curProduct || descProductCur != descProduct || categoryText != categoryProduct) {
    //        let productadd = {
    //            id: idProduct,
    //            title: titleProductCur,
    //            img: imgProductCur,
    //            category: categoryText,
    //            price: parseInt(curProductCur),
    //            desc: descProductCur,
    //            status: 1,
    //        };
    //        products.splice(indexCur, 1);
    //        products.splice(indexCur, 0, productadd);
    //        localStorage.setItem("products", JSON.stringify(products));
    //        toast({ title: "Success", message: "Sửa sản phẩm thành công!", type: "success", duration: 3000, });
    //        setDefaultValue();
    //        document.querySelector(".add-product").classList.remove("open");
    //        showProduct();
    //    } else {
    //        toast({ title: "Warning", message: "Sản phẩm của bạn không thay đổi!", type: "warning", duration: 3000, });
    //    }
    //});
    // On change Image
    function uploadImage(el) {
        let path = "~/assets/img/products/" + el.value.split("\\")[2];
        document.querySelector(".upload-image-preview").setAttribute("src", path);
    }
</script>

@section scripts_footer {
    <script>
        app.controller("mainCtrl", function ($scope, $http) {
            $scope.data = {
                product: {
                    isActive: true
                },
                support: {
                    imagePath: context.imagePath,
                }
            }

            $scope.init = function () {
                $scope.methods.loadInit();
            };

            $scope.events = {
                onAdd: function ($event) {
                    const button = $event.currentTarget;
                    shareData.loadButton.loading(button, true);

                    //console.log('$scope.data', $scope.data)
                    const data = {
                        product: $scope.data.product
                    }
                    $scope.methods.update(data, button)
                },
            };
            $scope.methods = {
                loadInit: function (button) {
                    $http({
                        url: '/api/admin/product/get-all',
                        method: "Get"
                    })
                        .then(function (response) {
                            console.log('data', response.data);

                            $scope.data.products = response.data.products;
                            $scope.data.support.categorys = response.data.categorys;
                        })
                        .catch(function (response) {
                            shareData.notification.exception();
                            console.error('catch error', response);
                        })
                        .finally(function () {
                            if (button != null) {
                                shareData.loadButton.loaded(button);
                            }
                        });
                },
                update: function (data, button) {

                    $http({
                        url: '/api/admin/product/update',
                        method: "POST",
                        data: data
                    })
                        .then(function (response) {
                            //console.log('response', response);
                            if (response.data.success == true) {
                                if (response.data?.objectResponses?.id > 0) {
                                    $scope.data.product.productId = response.data.objectResponses.id;
                                }
                                $scope.methods.loadInit(button);
                            }
                            else {
                                shareData.notification.fail(response.data.messageForUser)
                                console.error('response error', response)
                            }
                        })
                        .catch(function (response) {
                            shareData.notification.exception();
                            console.error('catch error', response);
                        })
                        .finally(function () {

                        });
                },
                checkBeforeUpload: function ($event) {
                    if (!$scope.data.product.productId) {
                        shareData.notification.fail('⚠️ Bạn cần lưu sản phẩm trước khi upload hình ảnh!')
                        $event.preventDefault(); // chặn click
                    }
                }
            };
            $scope.init();
        });
    </script>
}

